let selected=JSON.parse(localStorage.getItem('hyakunin-selected')||'[1,2,3,4,5,6,7,8,9,10]');let currentQuiz=[];let index=0;let correct=0;let wrong=0;let combo=0;let maxCombo=0;let highScore=0;let soundEnabled=true;let choiceCount=3;let autoSpeakEnabled=true;let hintMode='toggle';let quizCount=10;let feedbackTimer=null;let hasWrongAnswerInCurrentQuestion=false;let initialSelected=[...selected];const defaultPatterns=[{name: "ğŸ”° åˆç´šç·¨ï¼ˆ1-20é¦–ï¼‰",selected:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],quizCount: 10,isDefault: true},{name: "â­ ã‚€ã™ã‚ãµã•ã»ã›ï¼ˆä¸€å­—æ±ºã¾ã‚Šï¼‰",selected:[87,18,57,22,70,81,77],quizCount: 7,isDefault: true},{name: "ğŸ“š æœ‰åãªæ­Œãƒˆãƒƒãƒ—10",selected:[1,2,4,7,15,17,35,77,96,100],quizCount: 10,isDefault: true}];window.addEventListener('load',()=>{highScore=parseInt(localStorage.getItem('hyakunin-high-score')||'0');updateHighScore();createSakura();loadSettings();loadSelectedSongs();updateQuizCountOptions();initializeDefaultPatterns();const soundCheckbox=document.getElementById('sound-enabled');const choiceSelect=document.getElementById('choice-count');const autoSpeakCheckbox=document.getElementById('auto-speak-enabled');const hintModeSelect=document.getElementById('hint-mode');const quizCountSelect=document.getElementById('quiz-count');if(soundCheckbox)soundCheckbox.addEventListener('change',saveSettings);if(choiceSelect)choiceSelect.addEventListener('change',saveSettings);if(autoSpeakCheckbox)autoSpeakCheckbox.addEventListener('change',saveSettings);if(hintModeSelect)hintModeSelect.addEventListener('change',saveSettings);if(quizCountSelect)quizCountSelect.addEventListener('change',saveSettings);});function loadSettings(){soundEnabled=localStorage.getItem('sound-enabled')!=='false';choiceCount=parseInt(localStorage.getItem('choice-count')||'3');autoSpeakEnabled=localStorage.getItem('auto-speak-enabled')!=='false';hintMode=localStorage.getItem('hint-mode')||'toggle';const savedQuizCount=localStorage.getItem('quiz-count')||'10';if(savedQuizCount==='all'||savedQuizCount==='9999'){quizCount=9999;}else{quizCount=parseInt(savedQuizCount)||10;}const soundCheckbox=document.getElementById('sound-enabled');const choiceSelect=document.getElementById('choice-count');const autoSpeakCheckbox=document.getElementById('auto-speak-enabled');const hintModeSelect=document.getElementById('hint-mode');const quizCountSelect=document.getElementById('quiz-count');if(soundCheckbox)soundCheckbox.checked=soundEnabled;if(choiceSelect)choiceSelect.value=choiceCount;if(autoSpeakCheckbox)autoSpeakCheckbox.checked=autoSpeakEnabled;if(hintModeSelect)hintModeSelect.value=hintMode;if(quizCountSelect){updateQuizCountOptions();}}function showSettings(){document.getElementById("title-screen").classList.add("hidden");document.getElementById("settings-screen").classList.remove("hidden");loadSettings();}function saveSettings(){soundEnabled=document.getElementById('sound-enabled').checked;choiceCount=parseInt(document.getElementById('choice-count').value);autoSpeakEnabled=document.getElementById('auto-speak-enabled').checked;hintMode=document.getElementById('hint-mode').value;const quizCountValue=document.getElementById('quiz-count').value;quizCount=quizCountValue==='all' ? 9999 : parseInt(quizCountValue);localStorage.setItem('sound-enabled',soundEnabled);localStorage.setItem('choice-count',choiceCount);localStorage.setItem('auto-speak-enabled',autoSpeakEnabled);localStorage.setItem('hint-mode',hintMode);localStorage.setItem('quiz-count',quizCount);}function updateQuizCountOptions(){const quizCountSelect=document.getElementById('quiz-count');if(!quizCountSelect)return;const selectedCount=selected.length===0 ? 100 : selected.length;const options=[5,10,20,30,50,100];quizCountSelect.innerHTML='';options.forEach(count=>{if(count<=selectedCount){const option=document.createElement('option');option.value=count;option.textContent=`${count}å•`;quizCountSelect.appendChild(option);}});if(selectedCount<100){const allOption=document.createElement('option');allOption.value='all';allOption.textContent=`å…¨ã¦ï¼ˆ${selectedCount}å•ï¼‰`;quizCountSelect.appendChild(allOption);}const defaultValue=Math.min(selectedCount,10);const availableOptions=Array.from(quizCountSelect.options).map(opt=>opt.value);if(availableOptions.includes(String(defaultValue))){quizCountSelect.value=defaultValue;quizCount=defaultValue;}else if(availableOptions.length>0){const lastOption=quizCountSelect.options[quizCountSelect.options.length-1];quizCountSelect.value=lastOption.value;quizCount=lastOption.value==='all' ? 9999 : parseInt(lastOption.value);}}function updateHighScore(){document.getElementById('high-score-display').textContent=highScore;}function createSakura(){const container=document.getElementById('sakura-container');const sakuraCount=20;for(let i=0;i<sakuraCount;i++){const sakura=document.createElement('div');sakura.className='sakura';sakura.style.left=Math.random()*100+'%';sakura.style.animationDuration=(Math.random()*10+10)+'s';sakura.style.animationDelay=Math.random()*5+'s';sakura.style.opacity=Math.random()*0.5+0.3;container.appendChild(sakura);}}function startGame(){saveSettings();index=0;correct=0;wrong=0;combo=0;maxCombo=0;currentQuiz=[];hasWrongAnswerInCurrentQuestion=false;if(selected.length>0){currentQuiz=hyaku.filter(x=>selected.includes(x.id));}else{currentQuiz=[...hyaku];}shuffle(currentQuiz);let actualQuizCount;if(quizCount>=9999){actualQuizCount=currentQuiz.length;}else{actualQuizCount=Math.min(quizCount,currentQuiz.length);}currentQuiz=currentQuiz.slice(0,actualQuizCount);if(currentQuiz.length===0){currentQuiz=[...hyaku];shuffle(currentQuiz);if(quizCount>=9999){actualQuizCount=currentQuiz.length;}else{actualQuizCount=Math.min(quizCount,10);}currentQuiz=currentQuiz.slice(0,actualQuizCount);}document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));document.getElementById("quiz-screen").classList.remove("hidden");showQuiz();updateStats();}function showQuiz(){if(index>=currentQuiz.length){showResult();return;}const q=currentQuiz[index];hasWrongAnswerInCurrentQuestion=false;document.getElementById("card-number").textContent=`ç¬¬${q.id}é¦–`;const kamiElement=document.getElementById("kami");kamiElement.innerHTML=createRubyText(q.kanji,q.yomi);const choices=[q.shimo];while(choices.length<choiceCount){const rand=hyaku[Math.floor(Math.random()*hyaku.length)].shimo;if(!choices.includes(rand))choices.push(rand);}shuffle(choices);const container=document.getElementById("choices");container.innerHTML="";choices.forEach((c,i)=>{const btn=document.createElement("button");btn.textContent=c;btn.onclick=()=>answer(c===q.shimo,btn,q.shimo);btn.style.animationDelay=(i*0.1)+'s';container.appendChild(btn);});const existingAnswer=document.getElementById('correct-answer-display');if(existingAnswer){existingAnswer.remove();}updateStats();const hintContainer=document.getElementById('hint-container');const hintBtn=document.getElementById('hint-btn');const hintText=document.getElementById('hint-text');if(hintText)hintText.textContent=q.meaning||'ç¾ä»£èªè¨³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';if(hintMode==='always'){if(hintContainer)hintContainer.classList.remove('hidden');if(hintBtn)hintBtn.style.display='none';}else{if(hintContainer)hintContainer.classList.add('hidden');if(hintBtn){hintBtn.style.display='block';hintBtn.textContent='ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º';}}if(autoSpeakEnabled){setTimeout(()=>{speakKami();},300);}}function createRubyText(kanji,yomi){const cleanYomi=yomi.replace(/ã€/g,' ');const kanjiWords=kanji.split(/\s+/);const yomiWords=cleanYomi.split(/\s+/);let result='';for(let i=0;i<kanjiWords.length;i++){const k=kanjiWords[i];const y=yomiWords[i]||'';if(k===y||/^[ã-ã‚“]+$/.test(k)){result+=k;}else{result+=`<ruby>${k}<rt>${y}</rt></ruby>`;}if(i<kanjiWords.length-1){result+=' ';}}return result;}function answer(isCorrect,selectedButton,correctAnswer){const q=currentQuiz[index];if(isCorrect){const choiceButtons=document.querySelectorAll('#choices button');choiceButtons.forEach(btn=>btn.disabled=true);if(!hasWrongAnswerInCurrentQuestion){correct++;combo++;if(combo>maxCombo)maxCombo=combo;}else{combo=0;}selectedButton.classList.add('selected-correct');showFeedback('â­• æ­£è§£','correct');if(soundEnabled)playSound('correct');if(combo>=3){document.querySelector('.combo-box').classList.add('active');}else{document.querySelector('.combo-box').classList.remove('active');}if(autoSpeakEnabled){setTimeout(()=>{speakShimo(q.shimo);},400);}showNextButton(true);}else{if(!hasWrongAnswerInCurrentQuestion){wrong++;hasWrongAnswerInCurrentQuestion=true;}combo=0;selectedButton.classList.add('selected-wrong');selectedButton.disabled=true;showFeedback('âŒ æ®‹å¿µ','wrong');if(soundEnabled)playSound('wrong');document.querySelector('.combo-box').classList.remove('active');}updateStats();}function showNextButton(isCorrect){const container=document.getElementById('question-container');const existing=document.getElementById('correct-answer-display');if(existing){existing.remove();}const isLastQuestion=(index+1)>=currentQuiz.length;const buttonText=isLastQuestion ? 'çµæœã‚’è¦‹ã‚‹ â–¶' : 'æ¬¡ã®å•é¡Œã¸ â–¶';const buttonDiv=document.createElement('div');buttonDiv.id='correct-answer-display';buttonDiv.className='next-button-container';buttonDiv.innerHTML=`<button class="next-question-btn ${isCorrect ? 'correct-style' : ''}" onclick="goToNextQuestion()">${buttonText}</button>`;const cardContainer=container.querySelector('.card-container');cardContainer.insertAdjacentElement('afterend',buttonDiv);}function showCorrectAnswerWithButton(correctShimo){const container=document.getElementById('question-container');const existing=document.getElementById('correct-answer-display');if(existing){existing.remove();}const isLastQuestion=(index+1)>=currentQuiz.length;const buttonText=isLastQuestion ? 'çµæœã‚’è¦‹ã‚‹ â–¶' : 'æ¬¡ã®å•é¡Œã¸ â–¶';const answerDiv=document.createElement('div');answerDiv.id='correct-answer-display';answerDiv.className='correct-answer-display';answerDiv.innerHTML=`<div class="correct-label">æ­£è§£</div><div class="correct-shimo">${correctShimo}</div><button class="next-question-btn" onclick="goToNextQuestion()">${buttonText}</button>`;const cardContainer=container.querySelector('.card-container');cardContainer.insertAdjacentElement('afterend',answerDiv);}function goToNextQuestion(){hideCorrectAnswer();index++;showQuiz();}function hideCorrectAnswer(){const answerDiv=document.getElementById('correct-answer-display');if(answerDiv){answerDiv.remove();}}function showFeedback(text,type){const feedback=document.getElementById('feedback');if(feedbackTimer!==null){clearTimeout(feedbackTimer);feedbackTimer=null;}feedback.classList.add('hidden');requestAnimationFrame(()=>{feedback.textContent=text;feedback.className=`feedback ${type}`;feedback.style.animation='none';feedback.offsetHeight;feedback.style.animation='';feedback.classList.remove('hidden');feedbackTimer=setTimeout(()=>{feedback.classList.add('hidden');feedbackTimer=null;},1200);});}function playSound(type){const audioContext=new(window.AudioContext||window.webkitAudioContext)();const oscillator=audioContext.createOscillator();const gainNode=audioContext.createGain();oscillator.connect(gainNode);gainNode.connect(audioContext.destination);if(type==='correct'){oscillator.frequency.value=523.25;oscillator.type='sine';gainNode.gain.setValueAtTime(0.3,audioContext.currentTime);gainNode.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.3);oscillator.start(audioContext.currentTime);oscillator.stop(audioContext.currentTime+0.3);}else{oscillator.frequency.value=220;oscillator.type='triangle';gainNode.gain.setValueAtTime(0.2,audioContext.currentTime);gainNode.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.2);oscillator.start(audioContext.currentTime);oscillator.stop(audioContext.currentTime+0.2);}}function updateStats(){const total=correct+wrong;const rate=total===0 ? 0 : Math.round((correct/total)*100);document.getElementById("correct-count").textContent=rate+"%";document.getElementById("combo-count").textContent=combo;document.getElementById("progress-count").textContent=`${index}/${currentQuiz.length}`;}function showList(){document.getElementById("title-screen").classList.add("hidden");document.getElementById("list-screen").classList.remove("hidden");const container=document.getElementById("list-container");container.innerHTML="";const categories=[{name: "No.1(1-10é¦–)",range:[1,10]},{name: "No.2(11-20é¦–)",range:[11,20]},{name: "No.3(21-30é¦–)",range:[21,30]},{name: "No.4(31-40é¦–)",range:[31,40]},{name: "No.5(41-50é¦–)",range:[41,50]},{name: "No.6(51-60é¦–)",range:[51,60]},{name: "No.7(61-70é¦–)",range:[61,70]},{name: "No.8(71-80é¦–)",range:[71,80]},{name: "No.9(81-90é¦–)",range:[81,90]},{name: "No.10(91-100é¦–)",range:[91,100]}];categories.forEach((category,catIndex)=>{const categoryDiv=document.createElement("div");categoryDiv.className="category-header";categoryDiv.innerHTML=`<div class="category-title"><span class="category-name">${category.name}</span><button class="category-select-btn" onclick="selectCategory(${category.range[0]},${category.range[1]})">ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</button><button class="category-deselect-btn" onclick="deselectCategory(${category.range[0]},${category.range[1]})">è§£é™¤</button></div>`;container.appendChild(categoryDiv);const categoryContent=document.createElement("div");categoryContent.className="category-content";const wakaInCategory=hyaku.filter(x=>x.id>=category.range[0]&&x.id<=category.range[1]);wakaInCategory.forEach(x=>{const div=document.createElement("div");div.className="list-item";const isChecked=selected.includes(x.id);div.innerHTML=`<label class="list-label"><input type="checkbox" ${isChecked ? 'checked' : ''}onchange="toggleSelect(${x.id},this.checked)"><span class="list-number">${x.id}.</span><span class="list-text">${x.kanji}</span></label><button class="detail-btn" onclick="showWakaDetail(${x.id})">è©³ç´°</button>`;categoryContent.appendChild(div);});container.appendChild(categoryContent);});updateSelectedCount();loadSavedPatterns();updateSaveButtonState();}function selectCategory(start,end){for(let i=start;i<=end;i++){if(!selected.includes(i)){selected.push(i);}}saveSelectedSongs();showList();}function deselectCategory(start,end){selected=selected.filter(id=>id<start||id>end);saveSelectedSongs();showList();}function toggleSelect(id,checked){if(checked){if(!selected.includes(id)){selected.push(id);}}else{selected=selected.filter(x=>x!==id);}saveSelectedSongs();updateSelectedCount();updateQuizCountOptions();updateSaveButtonState();}function saveSelectedSongs(){localStorage.setItem('hyakunin-selected',JSON.stringify(selected));}function loadSelectedSongs(){const savedSelected=localStorage.getItem('hyakunin-selected');if(savedSelected){selected=JSON.parse(savedSelected);}}function selectAll(){selected=hyaku.map(x=>x.id);saveSelectedSongs();showList();updateQuizCountOptions();}function deselectAll(){selected=[];saveSelectedSongs();showList();updateQuizCountOptions();}function updateSelectedCount(){const countElement=document.getElementById('selected-count');countElement.textContent=selected.length;}function toggleHint(){const hintContainer=document.getElementById('hint-container');const hintBtn=document.getElementById('hint-btn');if(hintContainer.classList.contains('hidden')){hintContainer.classList.remove('hidden');hintBtn.textContent='ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’éè¡¨ç¤º';}else{hintContainer.classList.add('hidden');hintBtn.textContent='ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º';}}function showWakaDetail(id){const waka=hyaku.find(x=>x.id===id);if(!waka)return;const modal=document.createElement('div');modal.className='waka-detail-modal';modal.onclick=(e)=>{if(e.target===modal){modal.remove();}};const content=document.createElement('div');content.className='waka-detail-content';content.innerHTML=`<div class="waka-detail-header"><h3>ğŸ“œ ç¬¬${waka.id}é¦–</h3><button class="modal-close-btn" onclick="this.closest('.waka-detail-modal').remove()">Ã—</button></div><div class="waka-detail-body"><div class="waka-detail-section"><div class="waka-detail-label">ä¸Šã®å¥</div><div class="waka-detail-text">${waka.kanji}</div></div><div class="waka-detail-section"><div class="waka-detail-label">ä¸‹ã®å¥</div><div class="waka-detail-text">${waka.shimo}</div></div><div class="waka-detail-section"><div class="waka-detail-label">ç¾ä»£èªè¨³</div><div class="waka-detail-text">${waka.meaning||'ç¾ä»£èªè¨³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}</div></div></div><div class="waka-detail-footer"><button class="modal-ok-btn" onclick="this.closest('.waka-detail-modal').remove()">é–‰ã˜ã‚‹</button></div>`;modal.appendChild(content);document.body.appendChild(modal);}function backToTitle(){index=0;correct=0;wrong=0;combo=0;maxCombo=0;currentQuiz=[];document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));document.getElementById("title-screen").classList.remove("hidden");}function quitGame(){if(confirm('æŒ‘æˆ¦ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ')){showResult();}}function showResult(){document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));document.getElementById("result-screen").classList.remove("hidden");const total=correct+wrong;const rate=total===0 ? 0 : Math.round((correct/total)*100);if(maxCombo>highScore){highScore=maxCombo;localStorage.setItem('hyakunin-high-score',highScore);updateHighScore();}let rank='';let rankClass='';document.getElementById('result-rank').textContent='';document.getElementById('result-correct').textContent=correct;document.getElementById('result-wrong').textContent=wrong;document.getElementById('result-rate').textContent=rate+'%';document.getElementById('result-combo').textContent=maxCombo;document.getElementById('result-message').textContent='';if(maxCombo>0&&maxCombo===highScore){document.getElementById('result-message').textContent='ğŸ‰ æœ€é«˜è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼';}}function speakKami(){const q=currentQuiz[index];let kamiText=q.yomi;kamiText=kamiText .replace(/ã¯ãª/g,'ãƒãƒŠ').replace(/ã¯ã—/g,'ãƒã‚·').replace(/ã¯ã‚‹/g,'ãƒãƒ«').replace(/ã¯ã‚„/g,'ãƒãƒ¤').replace(/ã¯ã¦/g,'ãƒãƒ†').replace(/ã¯ã‚‰/g,'ãƒãƒ©').replace(/ã¯ã˜/g,'ãƒã‚¸').replace(/ã¯ã¾/g,'ãƒãƒ').replace(/ã¯ã‹/g,'ãƒã‚«').replace(/ã¯ã“/g,'ãƒã‚³');const uttr=new SpeechSynthesisUtterance(kamiText);uttr.lang="ja-JP";uttr.rate=0.7;uttr.pitch=1.2;uttr.volume=1.0;const voices=speechSynthesis.getVoices();const japaneseVoice=voices.find(voice=>voice.lang==='ja-JP'&&(voice.name.includes('Google')||voice.name.includes('Kyoko')||voice.name.includes('Otoya')||voice.name.includes('Female')))||voices.find(voice=>voice.lang==='ja-JP');if(japaneseVoice){uttr.voice=japaneseVoice;}uttr.onstart=()=>{const btn=document.querySelector('.speak-btn');if(btn){btn.style.background='linear-gradient(135deg,#1e3a8a 0%,#4169e1 100%)';}};uttr.onend=()=>{const btn=document.querySelector('.speak-btn');if(btn){btn.style.background='linear-gradient(135deg,#4169e1 0%,#1e3a8a 100%)';}};speechSynthesis.cancel();speechSynthesis.speak(uttr);if(soundEnabled){const btn=document.querySelector('.speak-btn');btn.style.transform='scale(0.95)';setTimeout(()=>{btn.style.transform='scale(1)';},200);}}function speakShimo(shimoText){let readableText=shimoText .replace(/ã¦ãµ/g,'ã¡ã‚‡ã†').replace(/ã¦ã†/g,'ã¡ã‚‡ã†').replace(/ã§ãµ/g,'ã˜ã‚‡ã†').replace(/ã§ã†/g,'ã˜ã‚‡ã†').replace(/ã‚/g,'ã„').replace(/ã‚‘/g,'ãˆ').replace(/ã‹ã‚ˆã²ã˜/g,'ã‹ã‚ˆã„ã˜').replace(/ã‹ã‘ã˜ã‚„/g,'ã‹ã‘ã˜ ã‚„').replace(/ã˜ã‚„/g,'ã˜ ã‚„').replace(/ãã‚„/g,'ã ã‚„').replace(/ã¯ãª/g,'__HANA__').replace(/ã¯ã—/g,'__HASHI__').replace(/ã¯ã‚‹/g,'__HARU__').replace(/ã¯ã‚„/g,'__HAYA__').replace(/ã¯ã¦/g,'__HATE__').replace(/ã¯ã‚‰/g,'__HARA__').replace(/ã¯ã˜/g,'__HAJI__').replace(/ã¯ã¾/g,'__HAMA__').replace(/ã¯ã‹/g,'__HAKA__').replace(/ã¯ã“/g,'__HAKO__').replace(/ã“ã²/g,'ã“ã„').replace(/ã‹ã²/g,'ã‹ã„').replace(/ã‚ã²/g,'ã‚ã„').replace(/ã‚ãµ/g,'ã‚ã†').replace(/ã‚ã¯/g,'ã‚ã‚').replace(/ãŠã‚‚ã²/g,'ãŠã‚‚ã„').replace(/ãŠã‚‚ãµ/g,'ãŠã‚‚ã†').replace(/ãŠã‚‚ã¸/g,'ãŠã‚‚ãˆ').replace(/ãŠã‚‚ã¯/g,'ãŠã‚‚ã‚').replace(/ã„ã²/g,'ã„ã„').replace(/ã„ãµ/g,'ã„ã†').replace(/__HANA__/g,'ãƒãƒŠ').replace(/__HASHI__/g,'ãƒã‚·').replace(/__HARU__/g,'ãƒãƒ«').replace(/__HAYA__/g,'ãƒãƒ¤').replace(/__HATE__/g,'ãƒãƒ†').replace(/__HARA__/g,'ãƒãƒ©').replace(/__HAJI__/g,'ãƒã‚¸').replace(/__HAMA__/g,'ãƒãƒ').replace(/__HAKA__/g,'ãƒã‚«').replace(/__HAKO__/g,'ãƒã‚³').replace(/([^ã-ã‚“])ã²/g,'$1ã„ ').replace(/([^ã-ã‚“])ã²([^ã-ã‚“])/g,'$1ã„$2').replace(/ãã‚/g,'ã‹').replace(/ãã‚/g,'ãŒ').replace(/ã‚ã‚‹/g,'ã„ã‚‹').replace(/ã‚‘ã‚‹/g,'ãˆã‚‹');const uttr=new SpeechSynthesisUtterance(readableText);uttr.lang="ja-JP";uttr.rate=0.7;uttr.pitch=1.2;uttr.volume=1.0;const voices=speechSynthesis.getVoices();const japaneseVoice=voices.find(voice=>voice.lang==='ja-JP'&&(voice.name.includes('Google')||voice.name.includes('Kyoko')||voice.name.includes('Otoya')||voice.name.includes('Female')))||voices.find(voice=>voice.lang==='ja-JP');if(japaneseVoice){uttr.voice=japaneseVoice;}speechSynthesis.cancel();speechSynthesis.speak(uttr);}if('speechSynthesis' in window){speechSynthesis.getVoices();window.speechSynthesis.onvoiceschanged=()=>{speechSynthesis.getVoices();};}function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}function resetAllData(){if(confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»æœ€é«˜è¨˜éŒ²\nãƒ»è¨­å®šå†…å®¹\nãƒ»é¸æŠã—ãŸæ­Œ\nãƒ»ä¿å­˜ã—ãŸé¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³\n\nã™ã¹ã¦ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚')){if(confirm('æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')){localStorage.clear();localStorage.setItem('hyakunin-patterns',JSON.stringify(defaultPatterns));selected=[1,2,3,4,5,6,7,8,9,10];highScore=0;soundEnabled=true;choiceCount=3;autoSpeakEnabled=true;hintMode='toggle';quizCount=10;index=0;correct=0;wrong=0;combo=0;maxCombo=0;currentQuiz=[];updateHighScore();loadSettings();loadSelectedSongs();alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚');backToTitle();}}}function initializeDefaultPatterns(){const patterns=JSON.parse(localStorage.getItem('hyakunin-patterns')||'[]');const hasDefaultPatterns=patterns.some(p=>p.isDefault);if(!hasDefaultPatterns){const newPatterns=[...defaultPatterns,...patterns];localStorage.setItem('hyakunin-patterns',JSON.stringify(newPatterns));}}function loadSavedPatterns(){const select=document.getElementById('pattern-select');if(!select)return;select.innerHTML='<option value="">ä¿å­˜æ¸ˆã¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ</option>';const patterns=JSON.parse(localStorage.getItem('hyakunin-patterns')||'[]');patterns.forEach((pattern,index)=>{const option=document.createElement('option');option.value=index;if(pattern.isDefault){option.textContent=pattern.name;}else{option.textContent=`${pattern.name}(${pattern.selected.length}é¦–)`;}select.appendChild(option);});}function savePattern(){const patterns=JSON.parse(localStorage.getItem('hyakunin-patterns')||'[]');let defaultName='';let counter=1;while(true){defaultName=`é¸æŠ${counter}`;if(!patterns.find(p=>p.name===defaultName)){break;}counter++;}const name=prompt('é¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š',defaultName);if(name===null){return;}if(name.trim()===''){alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');return;}const pattern={name: name.trim(),selected:[...selected],quizCount: quizCount,timestamp: new Date().toISOString()};const existingIndex=patterns.findIndex(p=>p.name===pattern.name);if(existingIndex>=0){if(confirm(`ã€Œ${pattern.name}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)){patterns[existingIndex]=pattern;}else{return;}}else{patterns.push(pattern);}localStorage.setItem('hyakunin-patterns',JSON.stringify(patterns));initialSelected=[...selected];updateSaveButtonState();alert(`ã€Œ${pattern.name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);loadSavedPatterns();}function loadPattern(){const select=document.getElementById('pattern-select');const selectedIndex=select.value;if(selectedIndex===''){alert('èª­ã¿è¾¼ã‚€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');return;}const patterns=JSON.parse(localStorage.getItem('hyakunin-patterns')||'[]');const pattern=patterns[parseInt(selectedIndex)];if(!pattern){alert('ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');return;}selected=[...pattern.selected];initialSelected=[...pattern.selected];console.log('ãƒ‘ã‚¿ãƒ¼ãƒ³èª­ã¿è¾¼ã¿:',pattern.name);console.log('é¸æŠã•ã‚ŒãŸæ­Œ:',selected);if(pattern.quizCount!==undefined){quizCount=pattern.quizCount;}saveSelectedSongs();saveSettings();showList();console.log('showListå®Ÿè¡Œå¾Œã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ•°:',document.querySelectorAll('.list-item input[type="checkbox"]:checked').length);updateQuizCountOptions();alert(`ã€Œ${pattern.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);}function renamePattern(){const select=document.getElementById('pattern-select');const selectedIndex=select.value;if(selectedIndex===''){alert('åå‰ã‚’å¤‰æ›´ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');return;}const patterns=JSON.parse(localStorage.getItem('hyakunin-patterns')||'[]');const pattern=patterns[parseInt(selectedIndex)];if(!pattern){alert('ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');return;}if(pattern.isDefault){alert('ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åå‰ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚');return;}const newName=prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š',pattern.name);if(newName===null){return;}if(newName.trim()===''){alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');return;}const duplicateIndex=patterns.findIndex((p,index)=>p.name===newName.trim()&&index!==parseInt(selectedIndex));if(duplicateIndex>=0){alert(`ã€Œ${newName.trim()}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);return;}const oldName=pattern.name;pattern.name=newName.trim();patterns[parseInt(selectedIndex)]=pattern;localStorage.setItem('hyakunin-patterns',JSON.stringify(patterns));alert(`ã€Œ${oldName}ã€ã‚’ã€Œ${pattern.name}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);loadSavedPatterns();select.value=selectedIndex;}function deletePattern(){const select=document.getElementById('pattern-select');const selectedIndex=select.value;if(selectedIndex===''){alert('å‰Šé™¤ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');return;}const patterns=JSON.parse(localStorage.getItem('hyakunin-patterns')||'[]');const pattern=patterns[parseInt(selectedIndex)];if(!pattern){alert('ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');return;}if(pattern.isDefault){alert('ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');return;}if(!confirm(`ã€Œ${pattern.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){return;}patterns.splice(parseInt(selectedIndex),1);localStorage.setItem('hyakunin-patterns',JSON.stringify(patterns));alert(`ã€Œ${pattern.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);loadSavedPatterns();}function hasSelectionChanged(){if(selected.length!==initialSelected.length){return true;}const sortedSelected=[...selected].sort((a,b)=>a-b);const sortedInitial=[...initialSelected].sort((a,b)=>a-b);for(let i=0;i<sortedSelected.length;i++){if(sortedSelected[i]!==sortedInitial[i]){return true;}}return false;}function updateSaveButtonState(){const saveButton=document.querySelector('.btn-save-pattern');if(!saveButton)return;const hasChanged=hasSelectionChanged();saveButton.disabled=!hasChanged;if(!hasChanged){saveButton.style.opacity='0.5';saveButton.style.cursor='not-allowed';}else{saveButton.style.opacity='1';saveButton.style.cursor='pointer';}}